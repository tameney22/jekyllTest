<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">

{% include head.html %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
<style>
    #highlight {
            color: red;
    }

    #search:focus {
        outline:0px !important;
        -webkit-appearance:none;
        box-shadow: none !important;
    }

    #results {
        margin: auto;
        width: 50%;
    }

    form {
        width: 50%;
        margin: auto;
    }

    .spinner {
        display: none;
    }

    #results .card {
        margin: 9px 0;
    }

    #numResults {
        text-align: center;
    }
</style>
<body>

{% include header.html %}
<main class="page-content" aria-label="Content">
    <div class="thinwrapper">
        <h2>Search Here</h2>
        <form onsubmit="searchFor();" role="search">    
            <div class="input-group mb-3">
                <input type="text" id="search" class="form-control" placeholder="Search Term" aria-label="term" aria-describedby="button-addon2" autofocus required>
                <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="submit" id="button-addon2"><i class="fas fa-search"></i></button>
                </div>
            </div>
        </form>
        <h5 id="numResults"></h5>
        <div id="results">
            <div class="spinner-border spinner" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <div id="lyst"></div>
        </div>
    </div>
</main>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
<script type="text/javascript">
    let xmlDocs = Array();
    const xmls = ["b.xml", "br.xml", "p.xml", "t.xml"]  
    
    xmls.forEach((file, index) => {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                addToList(this)
            }
        };
        xhttp.open("GET", `../editions/${file}`, true);
        xhttp.send();
    })
        
    function addToList(xml) {
        let xmlDoc = xml.responseXML;
        xmlDocs.push(xmlDoc);
    }

    function searchFor() {
        event.preventDefault();
        document.getElementById("lyst").innerHTML = "";
        let resultsCount = 0;
        var loadingIcon = document.getElementsByClassName("spinner")[0];
        var table = document.getElementsByClassName("table")[0];
        loadingIcon.style.display = "block";
        var term = document.getElementById("search").value.toLowerCase();
        xmlDocs.forEach((xmlDoc, index) => {
            xmlDoc.querySelectorAll('l').forEach(line => {
                if (line.textContent.toLowerCase().includes(term)) {
                    resultsCount++;
                    //The word to put back in the span
                    var index = line.textContent.toLowerCase().indexOf(term);
                    var word = line.textContent.substring(index, index + term.length);
                    //Regular Expression is needed in the replace function
                    var reg = new RegExp(term, "gi");
                    let text = line.textContent.replace(reg, `<span id="highlight">${word}</span>`)
                    let manuscript;
                    xmlDoc.querySelectorAll('title').forEach((title, index) => {
                        if (title.getAttribute("type") == 'manuscript') {
                            manuscript = title.textContent;
                            console.log(manuscript)
                        }
                    })
                    var html = `
                    <div class="card">
                        <div class="card-body">
                            <p class="card-text">${text}</p>
                            <h6 class="card-subtitle mb-2 text-muted">${manuscript}</h6>
                            
                        </div>
                    </div>
                    `
                    //<a href="#" class="card-link">Go Here</a>  <== for the button, not implemented yet
                    document.getElementById("lyst").innerHTML += html;
                }
            });
        });
        //Result thing
        document.getElementById("numResults").innerHTML = `${resultsCount} results found!`;
        loadingIcon.style.display = "none";
    }
</script>
{% include footer.html %}
</body>

</html>
